import{L as U,u as $,y as B,r as n,$ as m,j as e,a0 as F,Q as q,V as P,a1 as K,a2 as T,U as A,K as g}from"./main-Bt21LLck.js";import{g as y}from"./GroupService-Dh-bCvGO.js";import{B as x}from"./button-BARmkLdK.js";import"./alert-CI59Zt6X.js";import"./input-mT1JNf1K.js";import{L as O}from"./lock-CudpYHpY.js";import{G as H}from"./globe-Dfh2Ze3q.js";import{K as M}from"./key-mOMej07n.js";const se=()=>{var k;const{inviteCode:t}=U(),o=$(),{currentUser:l}=B(),[D,p]=n.useState(!0),[s,v]=n.useState(null),[N,c]=n.useState(""),[S,I]=n.useState(!1),[w,R]=n.useState(!1),[f,L]=n.useState(""),[G,h]=n.useState(""),[r,b]=n.useState(null);n.useEffect(()=>{(async()=>{if(!t){c("Invalid invite link"),p(!1);return}try{const{data:i,error:j}=await m.from("invite_codes").select("*").eq("code",t).eq("used",!1).single();if(j||!i){const{data:d,error:J}=await m.from("group_invitations").select("*").eq("invite_token",t).eq("status","pending").single();if(J||!d){try{const{data:u}=await m.from("groups").select("*").like("id",`${t.toLowerCase()}%`).limit(1);if(u&&u.length>0){const _=await y.getGroup(u[0].id);if(_){v(_),b({group_id:u[0].id,code:t}),p(!1);return}}}catch(u){console.error("Fallback group lookup failed:",u)}c("Invalid or expired invite link"),p(!1);return}const E=await y.getGroup(d.group_id);E?(v(E),b(d)):c("Group not found")}else{if(i.expires_at&&new Date(i.expires_at)<new Date){c("This invite link has expired"),p(!1);return}const d=await y.getGroup(i.group_id);d?(v(d),b(i)):c("Group not found")}}catch(i){console.error("Error fetching group:",i),c("Failed to load group information")}finally{p(!1)}})()},[t,l]);const C=async()=>{var i;if(!l){localStorage.setItem("pendingInvite",JSON.stringify({inviteCode:t,groupId:s.id,groupName:s.name,timestamp:Date.now()})),o(`/signup?invite=${t}`);return}const a=l.uid||l.id;if(r!=null&&r.password){if(!f){h("Please enter the invite password");return}if(f!==r.password){h("Incorrect password");return}}I(!0),h("");try{if((i=s.memberIds)!=null&&i.includes(a)){g.success("You are already a member of this group!"),o("/groups");return}if(!(s!=null&&s.id)){console.error("Group ID is missing:",s),g.error("Group information is missing");return}if(!a){console.error("User ID is missing:",l),g.error("User information is missing");return}console.log("Attempting to join group:",{groupId:s.id,userId:a}),await y.joinGroup(s.id,a),await m.from("invite_codes").update({used:!0,used_by:a,used_at:new Date().toISOString()}).eq("code",t),r&&r.id&&await m.from("group_invitations").update({status:"accepted",responded_at:new Date().toISOString()}).eq("id",r.id),g.success("Successfully joined the group!"),o("/groups")}catch(j){console.error("Error joining group:",j),g.error(j.message||"Failed to join group")}finally{I(!1)}};return D?e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsx(F,{color:"purple"})}):N?e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center p-8",children:e.jsx(q,{className:"bg-gray-800 border-red-500/20 max-w-md w-full",children:e.jsxs(P,{className:"text-center py-8",children:[e.jsx("p",{className:"text-red-500 mb-4",children:N}),e.jsx(x,{onClick:()=>o("/"),className:"bg-purple-600 hover:bg-purple-700",children:"Go to Home"})]})})}):e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center p-8",children:e.jsxs(q,{className:"bg-gray-800 border-purple-500/20 max-w-md w-full",children:[e.jsxs(K,{className:"text-center",children:[e.jsx("div",{className:"flex justify-center mb-4",children:e.jsx("div",{className:"w-20 h-20 bg-purple-600/20 rounded-full flex items-center justify-center text-4xl",children:(s==null?void 0:s.emoji)||"ðŸ‘¥"})}),e.jsx(T,{className:"text-2xl font-bold text-white",children:"You're invited to join"}),e.jsx("h2",{className:"text-3xl font-bold text-purple-400 mt-2",children:s==null?void 0:s.name})]}),e.jsxs(P,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-700/30 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(A,{className:"w-5 h-5 text-gray-400"}),e.jsx("span",{className:"text-gray-300",children:"Members"})]}),e.jsx("span",{className:"text-white font-medium",children:((k=s==null?void 0:s.members)==null?void 0:k.length)||0})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-700/30 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[(s==null?void 0:s.visibility)==="private"?e.jsx(O,{className:"w-5 h-5 text-gray-400"}):e.jsx(H,{className:"w-5 h-5 text-gray-400"}),e.jsx("span",{className:"text-gray-300",children:"Type"})]}),e.jsx("span",{className:"text-white font-medium capitalize",children:(s==null?void 0:s.visibility)||"Public"})]})]}),(s==null?void 0:s.description)&&e.jsx("div",{className:"p-4 bg-gray-700/30 rounded-lg",children:e.jsx("p",{className:"text-gray-300",children:s.description})}),l&&(r==null?void 0:r.password)&&!w&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm text-gray-400",children:"Enter invite password"}),e.jsxs("div",{className:"relative",children:[e.jsx(M,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsx("input",{type:"password",value:f,onChange:a=>{L(a.target.value),h("")},onKeyPress:a=>a.key==="Enter"&&C(),placeholder:"Enter password",className:"w-full pl-10 pr-4 py-2 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-purple-500"})]}),G&&e.jsx("p",{className:"text-red-400 text-sm",children:G})]}),w?e.jsxs("div",{className:"text-center p-6 bg-green-500/10 border border-green-500/20 rounded-lg",children:[e.jsx("p",{className:"text-green-400 font-medium",children:"Join request sent!"}),e.jsx("p",{className:"text-gray-400 text-sm mt-2",children:"The group admin will review your request."}),e.jsx(x,{onClick:()=>o("/groups"),className:"mt-4 bg-purple-600 hover:bg-purple-700",children:"Go to My Groups"})]}):e.jsx("div",{className:"space-y-3",children:l?e.jsx(x,{onClick:C,disabled:S||(r==null?void 0:r.password)&&!f,className:"w-full bg-purple-600 hover:bg-purple-700 text-white disabled:opacity-50",children:S?"Processing...":"Join Group"}):e.jsxs(e.Fragment,{children:[e.jsx(x,{onClick:()=>o(`/signup?redirect=/invite/${t}`),className:"w-full bg-purple-600 hover:bg-purple-700 text-white",children:"Sign Up to Join"}),e.jsx(x,{onClick:()=>o(`/login?redirect=/invite/${t}`),className:"w-full bg-gray-700 hover:bg-gray-600 text-white",children:"Already have an account? Log In"})]})}),!w&&e.jsx("div",{className:"text-center",children:e.jsx("button",{onClick:()=>o("/"),className:"text-gray-400 hover:text-white text-sm",children:"Cancel"})})]})]})})};export{se as default};
